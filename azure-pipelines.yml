trigger:
  branches:
    include:
      - main

pool:
  name: Default  # Your self-hosted Windows agent

variables:
  backendResourceGroup: 'VSP-TCH'
  backendStorageAccount: 'vesperstorage'
  backendContainer: 'tfstate'
  backendKey: 'terraform.tfstate'
  environment: 'dev'

  # Disable the Terraform checkpoint API to avoid self-signed cert errors
  TF_SKIP_CHECKPOINT: 'true'
  CHECKPOINT_DISABLE: '1'

stages:

# ----------------------------------------------------------
# STAGE 1 — TERRAFORM INIT
# ----------------------------------------------------------

  - stage: Terraform_Init
    displayName: "Terraform Init"
    jobs:
      - job: init
        steps:
          - checkout: self

          - script: |
              terraform version
            displayName: "Verify Terraform Installed"
          - task: TerraformTask@5
            displayName: "Terraform Init"
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azurerm'
              backendAzureRmResourceGroupName: 'VSP-TCH'
              backendAzureRmStorageAccountName: 'vesperstorage'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
                
# ----------------------------------------------------------
# STAGE 2 — TERRAFORM PLAN
# ----------------------------------------------------------
  - stage: Terraform_Plan
    displayName: "Terraform Plan"
    dependsOn: Terraform_Init
    condition: succeeded()
    jobs:
      - job: plan
        steps:
          - checkout: self
          - task: TerraformTask@5
            displayName: "Terraform Init"
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azurerm'
              backendAzureRmResourceGroupName: 'VSP-TCH'
              backendAzureRmStorageAccountName: 'vesperstorage'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'plan'
              environmentServiceNameAzureRM: 'Azurerm'
              commandOptions: '-out=tfplan'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'tfplan'
              artifact: 'tfplan'
              publishLocation: 'pipeline'
            displayName: "Publish Plan Artifact"

# ----------------------------------------------------------
# STAGE 3 — TERRAFORM APPLY
# ----------------------------------------------------------
  - stage: Terraform_Apply
    displayName: "Terraform Apply"
    dependsOn: Terraform_Plan
    condition: succeeded()
    jobs:
      - job: apply
        steps:
          - checkout: self

          - download: current
            artifact: tfplan

          - script: |
              terraform version
            displayName: "Verify Terraform Installed"
          - task: TerraformTask@5
            displayName: "Terraform Init"
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azurerm'
              backendAzureRmResourceGroupName: 'VSP-TCH'
              backendAzureRmStorageAccountName: 'vesperstorage'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'

          - script: |
              terraform apply -auto-approve tfplan
            displayName: "Terraform Apply"
            env:
              TF_SKIP_CHECKPOINT: $(TF_SKIP_CHECKPOINT)
              CHECKPOINT_DISABLE: $(CHECKPOINT_DISABLE)
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)